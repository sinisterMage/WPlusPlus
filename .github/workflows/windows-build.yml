name: 🪟 Build W++ LLVM CLI (Windows, Full LLVM)

on:
  workflow_dispatch:

jobs:
  build-windows:
    name: Build W++ with Full LLVM
    runs-on: windows-latest

    steps:
      - name: 🧱 Checkout repository
        uses: actions/checkout@v4

      - name: 🦀 Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: ⚙️ Install dependencies
        shell: pwsh
        run: |
          choco install cmake ninja git python3 visualstudio2022buildtools -y
          Write-Host "✅ Installed CMake, Ninja, Git, Python, and VS Build Tools"

      - name: 💾 Restore LLVM build cache
        uses: actions/cache@v4
        with:
          path: |
            C:\llvm-src
            C:\llvm-build
            C:\LLVM
          key: llvm15-full-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}

      - name: 🧩 Build Full LLVM from source
        shell: pwsh
        run: |
          $srcDir = "C:\llvm-src"
          $buildDir = "C:\llvm-build"
          $installDir = "C:\LLVM"

          if (!(Test-Path "$installDir\bin\llvm-config.exe")) {
            Write-Host "⬇️ Cloning LLVM 15.0.7 source..."
            if (!(Test-Path $srcDir)) {
              git clone https://github.com/llvm/llvm-project.git $srcDir --branch llvmorg-15.0.7 --depth 1
            } else {
              Write-Host "📦 LLVM source already cached."
            }

            Write-Host "🛠️ Configuring LLVM with full dependency tree enabled..."
            cmake -S "$srcDir\llvm" -B $buildDir `
              -G "Ninja" `
              -DCMAKE_BUILD_TYPE=Release `
              -DCMAKE_INSTALL_PREFIX=$installDir `
              -DCMAKE_C_COMPILER="cl.exe" `
              -DCMAKE_CXX_COMPILER="cl.exe" `
              -DLLVM_ENABLE_PROJECTS="clang;clang-tools-extra;lld;lldb;mlir;polly;openmp" `
              -DLLVM_TARGETS_TO_BUILD="all" `
              -DLLVM_BUILD_TOOLS=ON `
              -DLLVM_INCLUDE_BENCHMARKS=ON `
              -DLLVM_INCLUDE_DOCS=ON `
              -DLLVM_INCLUDE_EXAMPLES=ON `
              -DLLVM_INCLUDE_TESTS=ON `
              -DLLVM_ENABLE_RTTI=ON `
              -DLLVM_ENABLE_EH=ON `
              -DLLVM_ENABLE_ASSERTIONS=ON `
              -DLLVM_ENABLE_LIBXML2=ON `
              -DLLVM_ENABLE_TERMINFO=ON `
              -DLLVM_ENABLE_ZLIB=ON `
              -DLLVM_ENABLE_BINDINGS=ON `
              -DLLVM_USE_CRT_RELEASE=MT `
              -DPYTHON_EXECUTABLE="C:\Python311\python.exe"

            Write-Host "⚙️ Building full LLVM toolchain (this may take 2–3 hours)..."
            cmake --build $buildDir --target install --config Release
          } else {
            Write-Host "✅ Using cached LLVM build."
          }

          # === llvm-config detection ===
          $llvmConfig = "$installDir\bin\llvm-config.exe"
          if (!(Test-Path $llvmConfig)) {
            Write-Host "⚠️ llvm-config.exe not found. Searching recursively..."
            $found = Get-ChildItem -Path $installDir -Recurse -Filter "llvm-config.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($found) {
              Write-Host "✅ Found llvm-config.exe at $($found.FullName)"
              $llvmConfig = $found.FullName
            } else {
              Write-Host "❌ llvm-config.exe missing entirely — aborting build."
              exit 1
            }
          }

          Write-Host "🔍 llvm-config version check:"
          & $llvmConfig --version

          # Export environment vars
          "LLVM_SYS_150_PREFIX=$installDir" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          "LLVM_CONFIG_PATH=$llvmConfig" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          "$installDir\bin" | Out-File -FilePath $Env:GITHUB_PATH -Encoding utf8 -Append

      - name: ⚙️ Build W++ for Windows
        shell: pwsh
        run: |
          cargo build --release -p wpp-cli --target x86_64-pc-windows-msvc

      - name: 📦 Package binary
        shell: pwsh
        run: |
          mkdir dist
          Copy-Item target\x86_64-pc-windows-msvc\release\wpp-cli.exe dist\
          Compress-Archive -Path dist\wpp-cli.exe -DestinationPath dist\wpp-cli-x86_64-pc-windows-msvc.zip
          Get-FileHash dist\wpp-cli-x86_64-pc-windows-msvc.zip -Algorithm SHA256 | ForEach-Object {
            $_.Hash + "  wpp-cli-x86_64-pc-windows-msvc.zip" } > dist\wpp-cli-x86_64-pc-windows-msvc.sha256

      - name: 🆙 Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wpp-cli-x86_64-pc-windows-msvc
          path: dist/*
